{% extends "base.html" %}

{% block title %}Orders - Admin Panel{% endblock %}

{% block page_title %}Orders{% endblock %}

{% block content %}
<div
    class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-lg shadow-sm dark:shadow-none transition-theme">
    <div
        class="px-3 sm:px-6 py-3 sm:py-4 border-b border-gray-200 dark:border-gray-800 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0">
        <div class="flex items-center justify-between w-full sm:w-auto">
            <h2 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white">Orders</h2>
            <a href="{{ url_for('orders.create_order') }}"
                class="inline-flex items-center px-3 py-2 sm:px-4 sm:py-2 bg-pink hover:bg-pink-dark text-white text-xs sm:text-sm font-medium rounded-lg transition-colors">
                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Create Order
            </a>
        </div>
        <span class="text-xs sm:text-sm text-gray-500 dark:text-gray-400">{{ orders|length }} order{{ 's' if
            orders|length != 1 else '' }}</span>
    </div>

    {% if orders %}
    <div class="overflow-x-auto px-3 sm:px-6 py-4">
        <div class="inline-block min-w-full align-middle">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-800">
                <thead class="bg-gray-50 dark:bg-gray-800">
                    <tr>
                        <th
                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider min-w-[120px]">
                            Order Number</th>
                        <th
                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider min-w-[150px]">
                            Customer</th>
                        <th
                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider min-w-[200px]">
                            Items</th>
                        <th
                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider min-w-[200px]">
                            Items</th>
                        <th
                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Fulfillment</th>
                        <th
                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Total</th>
                        <th
                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Status</th>
                        <th
                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider min-w-[150px]">
                            Payment</th>
                        <th
                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Date</th>
                        <th
                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-800 bg-white dark:bg-gray-900">
                    {% for order in orders %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                        <td class="px-4 py-4">
                            <div class="flex items-center gap-2">
                                <div class="text-sm font-medium text-gray-900 dark:text-white">{{ order.order_number }}
                                </div>
                                {% if order.is_deal_order %}
                                <span
                                    class="px-1.5 py-0.5 text-[10px] uppercase font-bold text-white bg-pink rounded">Deal</span>
                                {% endif %}
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">ID: {{ order.id }}</div>
                        </td>
                        <td class="px-4 py-4">
                            {% if order.customer %}
                            <div class="text-sm font-medium text-gray-900 dark:text-white">{{ order.customer.full_name
                                }}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">{{ order.customer.email }}</div>
                            {% else %}
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                {% if order.billing_address %}
                                {% if order.billing_address.first_name or order.billing_address.last_name %}
                                {{ order.billing_address.first_name }} {{ order.billing_address.last_name }}
                                {% else %}
                                Guest
                                {% endif %}
                                {% else %}
                                Guest
                                {% endif %}
                            </div>
                            {% endif %}
                        </td>
                        <td class="px-4 py-4">
                            <div class="text-sm text-gray-900 dark:text-white">{{ order.items|length }} item{{ 's' if
                                order.items|length != 1 else '' }}</div>
                            {% if order.items %}
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                {% for item in order.items[:2] %}
                                {{ item.product_name }}{% if item.quantity > 1 %} (x{{ item.quantity }}){% endif %}{% if
                                not loop.last %}, {% endif %}
                                {% endfor %}
                                {% if order.items|length > 2 %}
                                <span class="text-gray-400">+{{ order.items|length - 2 }} more</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </td>

                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="flex flex-col">
                                <span
                                    class="text-xs font-semibold uppercase {% if order.fulfillment_source == 'pos' %}text-purple-600 dark:text-purple-400{% else %}text-gray-600 dark:text-gray-400{% endif %}">
                                    {{ order.fulfillment_source }}
                                </span>
                                {% if order.fulfillment_source == 'pos' %}
                                <span class="text-xs text-gray-500 dark:text-gray-400">
                                    {% if order.assigned_seller %}
                                    {{ order.assigned_seller.business_name }}
                                    {% else %}
                                    <span class="text-red-500">Unassigned</span>
                                    {% endif %}
                                </span>
                                {% if order.assignment_status %}
                                <span class="text-[10px] mt-0.5 px-1.5 py-0.5 rounded-full inline-block w-fit
                                            {% if order.assignment_status == 'accepted' %}bg-green-100 text-green-700
                                            {% elif order.assignment_status == 'rejected' %}bg-red-100 text-red-700
                                            {% elif order.assignment_status == 'assigned' %}bg-yellow-100 text-yellow-700
                                            {% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ order.assignment_status|title }}
                                </span>
                                {% endif %}
                                {% else %}
                                <span class="text-xs text-gray-500 dark:text-gray-400">Admin Direct</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 dark:text-white">
                            ${{ "%.2f"|format(order.total) }}
                        </td>
                        <td class="px-4 py-4">
                            {% set status_colors = {
                            'pending': 'bg-yellow-100 dark:bg-yellow-500/20 text-yellow-700 dark:text-yellow-400',
                            'processing': 'bg-blue-100 dark:bg-blue-500/20 text-blue-700 dark:text-blue-400',
                            'completed': 'bg-green-100 dark:bg-green-500/20 text-green-700 dark:text-green-400',
                            'cancelled': 'bg-red-100 dark:bg-red-500/20 text-red-700 dark:text-red-400'
                            } %}
                            {% set status_color = status_colors.get(order.status|lower, 'bg-gray-100 dark:bg-gray-500/20
                            text-gray-700 dark:text-gray-400') %}
                            <span class="px-2 py-1 text-xs rounded-full font-medium {{ status_color }}">{{
                                order.status|title }}</span>
                        </td>
                        <td class="px-4 py-4">
                            {% if order.payment_method %}
                            <div class="text-sm text-gray-900 dark:text-white capitalize">{{
                                order.payment_method|replace('_', ' ') }}</div>
                            {% if order.payment_transaction_id %}
                            <div class="text-xs text-gray-500 dark:text-gray-400 truncate max-w-xs"
                                title="{{ order.payment_transaction_id }}">
                                {{ order.payment_transaction_id[:20] }}...
                            </div>
                            {% endif %}
                            {% else %}
                            <span class="text-sm text-gray-400">â€”</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            <div>{{ order.created_at.strftime('%Y-%m-%d') }}</div>
                            <div class="text-xs">{{ order.created_at.strftime('%H:%M') }}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm">
                            <button onclick="viewOrderDetails({{ order.id }})"
                                class="px-3 py-1.5 bg-pink hover:bg-pink-dark text-white text-xs font-medium rounded-lg transition-colors">
                                View
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="p-12 text-center">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No orders</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by creating a new order or waiting for
            customer orders.</p>
    </div>
    {% endif %}
</div>

<!-- Order Details Modal -->
<div id="orderModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-2 sm:px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeOrderModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
        <div
            class="inline-block align-bottom bg-white dark:bg-gray-900 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full w-full max-h-[90vh] overflow-y-auto">
            <div class="bg-white dark:bg-gray-900 px-3 sm:px-4 md:px-6 pt-4 sm:pt-5 pb-4 sm:pb-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="modal-title">Order Details</h3>
                    <button onclick="closeOrderModal()"
                        class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="orderModalContent" class="space-y-6">
                    <!-- Loading state -->
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pink mx-auto"></div>
                        <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Loading order details...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentOrderData = null;

    function viewOrderDetails(orderId) {
        const modal = document.getElementById('orderModal');
        const content = document.getElementById('orderModalContent');

        // Show modal with loading state
        modal.classList.remove('hidden');
        content.innerHTML = `
        <div class="text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pink mx-auto"></div>
            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Loading order details...</p>
        </div>
    `;

        // Fetch order details
        fetch(`/admin/orders/${orderId}/details`)
            .then(response => response.json())
            .then(data => {
                currentOrderData = data;
                renderOrderDetails(data);
            })
            .catch(error => {
                console.error('Error fetching order details:', error);
                content.innerHTML = `
                <div class="text-center py-8">
                    <p class="text-red-500 dark:text-red-400">Error loading order details. Please try again.</p>
                </div>
            `;
            });
    }

    function closeOrderModal() {
        document.getElementById('orderModal').classList.add('hidden');
        currentOrderData = null;
    }

    function renderOrderDetails(order) {
        const content = document.getElementById('orderModalContent');

        // Format variation details
        function formatVariationDetails(variationDetails) {
            if (!variationDetails || Object.keys(variationDetails).length === 0) {
                return '<span class="text-gray-400 text-xs">No variation</span>';
            }
            return Object.entries(variationDetails).map(([key, value]) => {
                return `<span class="inline-block px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded text-xs mr-1 mb-1">
                <span class="font-medium">${key}:</span> ${value}
            </span>`;
            }).join('');
        }

        // Format address
        function formatAddress(address) {
            if (!address) return 'N/A';
            const parts = [];
            if (address.first_name || address.last_name) {
                parts.push(`${address.first_name || ''} ${address.last_name || ''}`.trim());
            }
            if (address.address) parts.push(address.address);
            if (address.city) parts.push(address.city);
            if (address.state) parts.push(address.state);
            if (address.zipCode) parts.push(address.zipCode);
            if (address.country) parts.push(address.country);
            return parts.length > 0 ? parts.join(', ') : 'N/A';
        }

        // Status color mapping
        const statusColors = {
            'pending': 'bg-yellow-100 dark:bg-yellow-500/20 text-yellow-700 dark:text-yellow-400',
            'processing': 'bg-blue-100 dark:bg-blue-500/20 text-blue-700 dark:text-blue-400',
            'completed': 'bg-green-100 dark:bg-green-500/20 text-green-700 dark:text-green-400',
            'cancelled': 'bg-red-100 dark:bg-red-500/20 text-red-700 dark:text-red-400'
        };
        const statusColor = statusColors[order.status.toLowerCase()] || 'bg-gray-100 dark:bg-gray-500/20 text-gray-700 dark:text-gray-400';

        content.innerHTML = `
        <!-- Order Header -->
        <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Order Number</p>
                    <p class="text-sm font-semibold text-gray-900 dark:text-white">${order.order_number}</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Status</p>
                    <form action="/admin/orders/${order.id}/update-status" method="POST" class="inline-block">
                        <select name="status" onchange="this.form.submit()" class="text-xs rounded-full font-medium ${statusColor} border-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 cursor-pointer">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                            <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completed</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </form>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Date</p>
                    <p class="text-sm text-gray-900 dark:text-white">${order.created_at || 'N/A'}</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Total</p>
                    <p class="text-sm font-semibold text-gray-900 dark:text-white">$${order.total.toFixed(2)}</p>
                </div>
            </div>
        </div>
        
        <!-- Customer Information -->
        <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
            <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Customer Information</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Name</p>
                    <p class="text-sm text-gray-900 dark:text-white">${order.customer.full_name || 'Guest'}</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Email</p>
                    <p class="text-sm text-gray-900 dark:text-white">${order.customer.email || 'N/A'}</p>
                </div>
            </div>
        </div>
        
        <!-- Order Items -->
        <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
            <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Order Items</h4>
            <div class="space-y-3">
                ${order.items.map(item => `
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 sm:p-4">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 sm:gap-0 mb-2">
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-900 dark:text-white">${item.product_name}</p>
                                <div class="mt-1">${formatVariationDetails(item.variation_details)}</div>
                            </div>
                            <div class="text-left sm:text-right sm:ml-4">
                                <p class="text-sm font-semibold text-gray-900 dark:text-white">$${item.price.toFixed(2)}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Qty: ${item.quantity}</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center pt-2 border-t border-gray-200 dark:border-gray-700">
                            <p class="text-xs text-gray-500 dark:text-gray-400">Subtotal</p>
                            <p class="text-sm font-medium text-gray-900 dark:text-white">$${item.subtotal.toFixed(2)}</p>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        
        <!-- Order Totals -->
        <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
            <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Order Summary</h4>
            <div class="space-y-2">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400">Subtotal</span>
                    <span class="text-gray-900 dark:text-white">$${order.subtotal.toFixed(2)}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400">Tax</span>
                    <span class="text-gray-900 dark:text-white">$${order.tax.toFixed(2)}</span>
                </div>
                <div class="flex justify-between text-base font-semibold pt-2 border-t border-gray-200 dark:border-gray-700">
                    <span class="text-gray-900 dark:text-white">Total</span>
                    <span class="text-gray-900 dark:text-white">$${order.total.toFixed(2)}</span>
                </div>
            </div>
        </div>
        
        <!-- Payment Information -->
        <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
            <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Payment Information</h4>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Payment Method</p>
                    <p class="text-sm text-gray-900 dark:text-white capitalize">${(order.payment_method || 'N/A').replace('_', ' ')}</p>
                </div>
                ${order.payment_transaction_id ? `
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Transaction ID</p>
                    <p class="text-sm text-gray-900 dark:text-white font-mono text-xs">${order.payment_transaction_id}</p>
                </div>
                ` : ''}
            </div>
        </div>
        
        <!-- Addresses -->
        <div class="grid grid-cols-2 gap-4">
            <div>
                <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Billing Address</h4>
                <p class="text-xs text-gray-600 dark:text-gray-400 whitespace-pre-line">${formatAddress(order.billing_address)}</p>
            </div>
            <div>
                <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Shipping Address</h4>
                <p class="text-xs text-gray-600 dark:text-gray-400 whitespace-pre-line">${formatAddress(order.shipping_address)}</p>
            </div>
        </div>
    `;
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeOrderModal();
        }
    });
</script>
{% endblock %}