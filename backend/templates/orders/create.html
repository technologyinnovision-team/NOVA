{% extends "base.html" %}

{% block title %}Create Order - Admin Panel{% endblock %}

{% block page_title %}Create Order{% endblock %}

{% block content %}
<div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-lg shadow-sm p-6">
    <form method="POST" action="{{ url_for('orders.create_order') }}" id="createOrderForm">
        <!-- Customer Information -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Customer Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Customer Email
                        *</label>
                    <input type="email" name="customer_email" required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-pink focus:border-transparent dark:bg-gray-800 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Phone</label>
                    <input type="tel" name="phone"
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-pink focus:border-transparent dark:bg-gray-800 dark:text-white">
                </div>
            </div>
        </div>

        <!-- Billing Address -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Billing Address</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">First Name *</label>
                    <input type="text" name="billing_first_name" required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-pink focus:border-transparent dark:bg-gray-800 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Last Name *</label>
                    <input type="text" name="billing_last_name" required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-pink focus:border-transparent dark:bg-gray-800 dark:text-white">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Address *</label>
                    <input type="text" name="billing_address" required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-pink focus:border-transparent dark:bg-gray-800 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">City *</label>
                    <input type="text" name="billing_city" required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-pink focus:border-transparent dark:bg-gray-800 dark:text-white">
                </div>
                <div>
                    <label
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">State/Province</label>
                    <input type="text" name="billing_state"
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-pink focus:border-transparent dark:bg-gray-800 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ZIP/Postal Code
                        *</label>
                    <input type="text" name="billing_zipcode" required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-pink focus:border-transparent dark:bg-gray-800 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Country *</label>
                    <input type="text" name="billing_country" required value="Pakistan"
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-pink focus:border-transparent dark:bg-gray-800 dark:text-white">
                </div>
            </div>
        </div>

        <!-- Order Items -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Order Items</h3>
            <div id="orderItems">
                <!-- Item template will be added via JavaScript -->
            </div>
            <button type="button" onclick="addOrderItem()"
                class="mt-4 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">
                + Add Item
            </button>
        </div>

        <!-- Payment & Order Details -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Order Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Payment Method
                        *</label>
                    <select name="payment_method" required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-pink focus:border-transparent dark:bg-gray-800 dark:text-white">
                        <option value="cash_on_delivery">Cash on Delivery</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="stripe">Credit Card (Stripe)</option>
                        <option value="paypal">PayPal</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Order Status
                        *</label>
                    <select name="status" required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-pink focus:border-transparent dark:bg-gray-800 dark:text-white">
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="flex justify-end gap-4">
            <a href="{{ url_for('orders.list') }}"
                class="px-6 py-2 border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
                Cancel
            </a>
            <button type="submit" class="px-6 py-2 bg-pink hover:bg-pink-dark text-white rounded-lg">
                Create Order
            </button>
        </div>
    </form>
</div>

<!-- Product Search Modal -->
<div id="productSearchModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title"
    role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
            onclick="closeProductSearch()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div
            class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title">
                            Search Product
                        </h3>
                        <div class="mt-4">
                            <div class="relative">
                                <input type="text" id="productSearchInput" placeholder="Search by name, SKU..."
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-pink focus:border-transparent dark:bg-gray-700 dark:text-white"
                                    onkeyup="debounceSearch()">
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </div>
                            </div>
                            <div id="searchResults" class="mt-4 max-h-60 overflow-y-auto space-y-2">
                                <!-- Results will appear here -->
                                <p class="text-sm text-gray-500 text-center py-4">Start typing to search products...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                    onclick="closeProductSearch()">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let itemCounter = 0;
    let activeSearchRowId = null;
    let searchTimeout = null;

    function addOrderItem() {
        itemCounter++;
        const container = document.getElementById('orderItems');
        const itemDiv = document.createElement('div');
        itemDiv.className = 'border border-gray-300 dark:border-gray-700 rounded-lg p-4 mb-4 relative';
        itemDiv.id = `item-${itemCounter}`;

        itemDiv.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h5 class="font-medium text-gray-900 dark:text-white">Item #${itemCounter}</h5>
            <button type="button" onclick="removeItem(${itemCounter})" class="text-red-600 hover:text-red-700 text-sm">Remove</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-3">
                 <button type="button" onclick="openProductSearch(${itemCounter})" 
                    class="w-full mb-3 flex items-center justify-center px-4 py-2 border border-blue-300 text-blue-700 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    Search & Select Product
                </button>
            </div>
            <div class="md:col-span-1">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Product ID *</label>
                <input type="number" name="items[${itemCounter}][product_id]" id="product_id_${itemCounter}" required readonly
                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-100 dark:bg-gray-900 text-gray-500 cursor-not-allowed">
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Product Name *</label>
                <input type="text" name="items[${itemCounter}][product_name]" id="product_name_${itemCounter}" required readonly
                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-100 dark:bg-gray-900 text-gray-500 cursor-not-allowed">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Quantity *</label>
                <input type="number" name="items[${itemCounter}][quantity]" value="1" min="1" required
                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-pink focus:border-transparent dark:bg-gray-800 dark:text-white">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Price (Per Unit) *</label>
                <input type="number" step="0.01" name="items[${itemCounter}][price]" id="product_price_${itemCounter}" required
                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-pink focus:border-transparent dark:bg-gray-800 dark:text-white">
            </div>
        </div>
    `;

        container.appendChild(itemDiv);
    }

    function removeItem(id) {
        const item = document.getElementById(`item-${id}`);
        if (item) {
            item.remove();
        }
    }

    // Modal Functions
    function openProductSearch(rowId) {
        activeSearchRowId = rowId;
        document.getElementById('productSearchInput').value = '';
        document.getElementById('searchResults').innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Start typing to search products...</p>';
        document.getElementById('productSearchModal').classList.remove('hidden');
        document.getElementById('productSearchInput').focus();
    }

    function closeProductSearch() {
        document.getElementById('productSearchModal').classList.add('hidden');
        activeSearchRowId = null;
    }

    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 500);
    }

    async function performSearch() {
        const query = document.getElementById('productSearchInput').value.trim();
        const resultsContainer = document.getElementById('searchResults');

        if (query.length < 2) {
            resultsContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Type at least 2 characters...</p>';
            return;
        }

        resultsContainer.innerHTML = '<div class="flex justify-center py-4"><svg class="animate-spin h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

        try {
            // Using existing API that supports search
            const response = await fetch(`/api/v1/products/collections?search=${encodeURIComponent(query)}&per_page=10`);
            const data = await response.json();

            if (data.success && data.data.products.length > 0) {
                resultsContainer.innerHTML = data.data.products.map(product => `
                    <div onclick="selectProduct(${product.id}, '${escapeHtml(product.title)}', ${product.sale_price || product.price})" 
                         class="cursor-pointer p-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg flex items-center justify-between transition-colors border-b border-gray-100 dark:border-gray-700 last:border-0">
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 bg-gray-200 rounded overflow-hidden flex-shrink-0">
                                ${product.image ? `<img src="${product.image}" class="h-full w-full object-cover">` : ''}
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">${product.title}</p>
                                <p class="text-xs text-gray-500">SKU: ${product.sku || 'N/A'}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-gray-900 dark:text-white">Rs ${product.price}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                resultsContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No products found.</p>';
            }
        } catch (error) {
            console.error('Search error:', error);
            resultsContainer.innerHTML = '<p class="text-sm text-red-500 text-center py-4">Error searching products.</p>';
        }
    }

    function selectProduct(id, title, price) {
        if (activeSearchRowId) {
            document.getElementById(`product_id_${activeSearchRowId}`).value = id;
            document.getElementById(`product_name_${activeSearchRowId}`).value = title;
            document.getElementById(`product_price_${activeSearchRowId}`).value = price;
            closeProductSearch();
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Add one item by default
    addOrderItem();
</script>
{% endblock %}