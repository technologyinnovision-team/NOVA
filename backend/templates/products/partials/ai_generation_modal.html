<!-- AI Generation Modal -->
<div id="ai-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-gray-900/75 backdrop-blur-sm transition-opacity opacity-0" id="ai-modal-backdrop">
    </div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <!-- Modal Panel -->
            <div class="relative transform overflow-hidden rounded-2xl bg-white dark:bg-gray-800 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                id="ai-modal-panel">

                <!-- Header -->
                <div
                    class="bg-gradient-to-r from-gray-900 to-gray-800 dark:from-gray-800 dark:to-black px-6 py-4 flex justify-between items-center border-b border-gray-700">
                    <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                        <svg class="h-5 w-5 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        AI Product Assistant
                    </h3>
                    <button type="button" onclick="AIModal.close()"
                        class="text-gray-400 hover:text-white transition-colors">
                        <span class="sr-only">Close</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Body -->
                <div class="px-6 py-6 space-y-6">
                    <!-- Series Name -->
                    <div>
                        <label for="ai-series-name"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Series Name /
                            Reference</label>
                        <input type="text" id="ai-series-name"
                            class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-yellow-500 focus:ring-yellow-500 sm:text-sm"
                            placeholder="e.g. Summer Collection 2025, Luxury Lawn Vol. 1">
                    </div>

                    <!-- Prompt -->
                    <div>
                        <label for="ai-prompt"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Instructions</label>
                        <textarea id="ai-prompt" rows="3"
                            class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-yellow-500 focus:ring-yellow-500 sm:text-sm"
                            placeholder="Describe how you want the content generated (e.g. 'Formal tone, emphasize embroidery details')."></textarea>
                    </div>

                    <!-- Options -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Generate
                            Fields</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label
                                class="inline-flex items-center p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer transition-colors group">
                                <input type="checkbox"
                                    class="rounded border-gray-300 text-yellow-500 focus:ring-yellow-500 ai-option"
                                    value="title" checked>
                                <span
                                    class="ml-2 text-sm text-gray-700 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-white">Title</span>
                            </label>

                            <label
                                class="inline-flex items-center p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer transition-colors group">
                                <input type="checkbox"
                                    class="rounded border-gray-300 text-yellow-500 focus:ring-yellow-500 ai-option"
                                    value="short_description" checked>
                                <span
                                    class="ml-2 text-sm text-gray-700 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-white">Short
                                    Description</span>
                            </label>

                            <label
                                class="inline-flex items-center p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer transition-colors group">
                                <input type="checkbox"
                                    class="rounded border-gray-300 text-yellow-500 focus:ring-yellow-500 ai-option"
                                    value="description" checked>
                                <span
                                    class="ml-2 text-sm text-gray-700 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-white">Long
                                    Description</span>
                            </label>

                            <label
                                class="inline-flex items-center p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer transition-colors group">
                                <input type="checkbox"
                                    class="rounded border-gray-300 text-yellow-500 focus:ring-yellow-500 ai-option"
                                    value="price">
                                <span
                                    class="ml-2 text-sm text-gray-700 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-white">Price
                                    Estimation</span>
                            </label>

                            <label
                                class="inline-flex items-center p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer transition-colors group">
                                <input type="checkbox"
                                    class="rounded border-gray-300 text-yellow-500 focus:ring-yellow-500 ai-option"
                                    value="seo">
                                <span
                                    class="ml-2 text-sm text-gray-700 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-white">SEO
                                    Meta</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="px-6 py-4 bg-gray-50 dark:bg-gray-700/50 flex justify-end gap-3">
                    <button type="button" onclick="AIModal.close()"
                        class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-sm font-medium">
                        Cancel
                    </button>
                    <button type="button" onclick="AIModal.generate()"
                        class="px-4 py-2 rounded-lg bg-black dark:bg-white text-white dark:text-black hover:bg-gray-800 dark:hover:bg-gray-100 transition-colors text-sm font-medium flex items-center gap-2 shadow-lg">
                        <span id="ai-btn-text">Generate Content</span>
                        <svg id="ai-btn-spinner" class="animate-spin h-4 w-4 hidden" xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const AIModal = {
        el: document.getElementById('ai-modal'),
        backdrop: document.getElementById('ai-modal-backdrop'),
        panel: document.getElementById('ai-modal-panel'),

        open() {
            this.el.classList.remove('hidden');
            // Animate in
            setTimeout(() => {
                this.backdrop.classList.remove('opacity-0');
                this.panel.classList.remove('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');
                this.panel.classList.add('opacity-100', 'translate-y-0', 'sm:scale-100');
            }, 10);
        },

        close() {
            // Animate out
            this.backdrop.classList.add('opacity-0');
            this.panel.classList.remove('opacity-100', 'translate-y-0', 'sm:scale-100');
            this.panel.classList.add('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');

            setTimeout(() => {
                this.el.classList.add('hidden');
            }, 300);
        },

        async generate() {
            const btn = document.querySelector('#ai-modal-panel button[onclick="AIModal.generate()"]');
            const btnText = document.getElementById('ai-btn-text');
            const spinner = document.getElementById('ai-btn-spinner');

            // 1. Gather Data
            const seriesName = document.getElementById('ai-series-name').value;
            const prompt = document.getElementById('ai-prompt').value;
            const options = Array.from(document.querySelectorAll('.ai-option:checked')).map(cb => cb.value);

            // Get images from global currentImages (defined in media_gallery.html)
            // Filter out placeholders if any, though currentImages usually has valid urls
            const images = ConvertImagesForAI(currentImages);

            if (!images || images.length === 0) {
                alert('Please add at least one image to the gallery first.');
                return;
            }

            if (!prompt && !seriesName) {
                if (!confirm('You have not provided any instructions or series name. Proceed anyway?')) return;
            }

            // 2. UI Loading State
            btn.disabled = true;
            btnText.textContent = 'Analyzing & Generating...';
            spinner.classList.remove('hidden');

            try {
                // 3. API Call
                const response = await fetch('/admin/products/generate-ai-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        series_name: seriesName,
                        prompt: prompt,
                        options: options,
                        images: images
                    })
                });

                const data = await response.json();

                if (!response.ok) throw new Error(data.error || 'Generation failed');

                // 4. Populate Fields
                this.populateFields(data, options);

                // 5. Close & Reset
                this.close();
                alert('Content generated successfully!');

            } catch (err) {
                console.error(err);
                alert('Error: ' + err.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Generate Content';
                spinner.classList.add('hidden');
            }
        },

        populateFields(data, options) {
            // Title
            if (options.includes('title') && data.title) {
                document.getElementById('title').value = data.title;
                // Trigger slug generation
                document.getElementById('title').dispatchEvent(new Event('input'));
            }

            // Short Description
            if (options.includes('short_description') && data.short_description) {
                document.getElementById('short_description').value = data.short_description;
            }

            // Long Description (Quill)
            if (options.includes('description') && data.description) {
                // Try to find Quill instance
                const editorContainer = document.getElementById('editor-container');
                /* global Quill */
                if (editorContainer && Quill) {
                    const quill = Quill.find(editorContainer);
                    if (quill) {
                        quill.root.innerHTML = data.description;
                    } else {
                        // Fallback if Quill instance not found attached to DOM (rare)
                        editorContainer.innerHTML = data.description;
                        document.getElementById('description_input').value = data.description;
                    }
                }
            }

            // Price
            if (options.includes('price') && data.price) {
                // Assuming data.price is a number or string "123.00"
                const priceInput = document.querySelector('input[name="regular_price"]');
                if (priceInput) priceInput.value = data.price;
            }

            // SEO
            if (options.includes('seo')) {
                const metaTitle = document.querySelector('input[name="meta_title"]');
                const metaDesc = document.querySelector('textarea[name="meta_description"]');
                if (metaTitle && data.meta_title) metaTitle.value = data.meta_title;
                if (metaDesc && data.meta_description) metaDesc.value = data.meta_description;
            }
        }
    };

    function ConvertImagesForAI(images) {
        // Returns array of URLs. 
        // We prioritize new images (base64 data URLs) or existing URLs.
        return images.map(img => img.url);
    }
</script>