{% extends "base.html" %}

{% block title %}Settings - Admin Panel{% endblock %}

{% block page_title %}Settings{% endblock %}

{% block content %}
<div
    class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-lg shadow-sm dark:shadow-none transition-theme">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">General Settings</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Manage your store configuration</p>
    </div>

    <form method="POST" class="p-6 space-y-6">
        <!-- Tax Settings -->
        <div
            class="bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg p-6 shadow-sm dark:shadow-none transition-theme">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                        </path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Tax Settings</h3>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Configure tax calculation and display</p>
                </div>
            </div>

            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <label for="tax_enabled"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Enable Tax</label>
                        <p class="text-xs text-gray-500 dark:text-gray-500">Enable tax calculation for orders</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="tax_enabled" id="tax_enabled" {% if tax_settings.enabled
                            %}checked{% endif %} class="sr-only peer">
                        <div
                            class="w-11 h-6 bg-gray-300 dark:bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-gold rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink">
                        </div>
                    </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="tax_rate"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tax Rate (%)</label>
                        <input type="number" id="tax_rate" name="tax_rate" value="{{ tax_settings.rate }}" step="0.01"
                            min="0" max="100"
                            class="w-full px-4 py-2.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-theme">
                    </div>

                    <div>
                        <label for="tax_calculation_method"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Calculation
                            Method</label>
                        <select id="tax_calculation_method" name="tax_calculation_method"
                            class="w-full px-4 py-2.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-theme">
                            <option value="per_item" {% if tax_settings.calculation_method=='per_item' %}selected{%
                                endif %}>Per Item</option>
                            <option value="per_line" {% if tax_settings.calculation_method=='per_line' %}selected{%
                                endif %}>Per Line</option>
                            <option value="total" {% if tax_settings.calculation_method=='total' %}selected{% endif %}>
                                Total</option>
                        </select>
                    </div>

                    <div>
                        <label for="tax_display"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Display
                            Method</label>
                        <select id="tax_display" name="tax_display"
                            class="w-full px-4 py-2.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-theme">
                            <option value="exclusive" {% if tax_settings.display=='exclusive' %}selected{% endif %}>
                                Exclusive (tax added)</option>
                            <option value="inclusive" {% if tax_settings.display=='inclusive' %}selected{% endif %}>
                                Inclusive (tax included)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- SMTP Settings -->
        <div
            class="bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg p-6 shadow-sm dark:shadow-none transition-theme">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                        </path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">SMTP Settings</h3>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Configure email server for sending emails</p>
                </div>
            </div>

            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <label for="smtp_enabled"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Enable SMTP</label>
                        <p class="text-xs text-gray-500 dark:text-gray-500">Enable SMTP email sending</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="smtp_enabled" id="smtp_enabled" {% if smtp_settings.enabled
                            %}checked{% endif %} class="sr-only peer">
                        <div
                            class="w-11 h-6 bg-gray-300 dark:bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-gold rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink">
                        </div>
                    </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="smtp_host"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">SMTP Host</label>
                        <input type="text" id="smtp_host" name="smtp_host" value="{{ smtp_settings.host }}"
                            placeholder="smtp.example.com"
                            class="w-full px-4 py-2.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-theme">
                    </div>

                    <div>
                        <label for="smtp_port"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">SMTP Port</label>
                        <input type="number" id="smtp_port" name="smtp_port" value="{{ smtp_settings.port }}"
                            placeholder="587"
                            class="w-full px-4 py-2.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-theme">
                    </div>

                    <div>
                        <label for="smtp_username"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">SMTP
                            Username</label>
                        <input type="text" id="smtp_username" name="smtp_username" value="{{ smtp_settings.username }}"
                            placeholder="your-email@example.com"
                            class="w-full px-4 py-2.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-theme">
                    </div>

                    <div>
                        <label for="smtp_password"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">SMTP
                            Password</label>
                        <input type="password" id="smtp_password" name="smtp_password"
                            placeholder="{% if smtp_settings.password %}Enter new password to change{% else %}Enter password{% endif %}"
                            class="w-full px-4 py-2.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-theme">
                        <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">Leave blank to keep existing password
                        </p>
                    </div>

                    <div>
                        <label for="smtp_encryption"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Encryption</label>
                        <select id="smtp_encryption" name="smtp_encryption"
                            class="w-full px-4 py-2.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-theme">
                            <option value="tls" {% if smtp_settings.encryption=='tls' %}selected{% endif %}>TLS</option>
                            <option value="ssl" {% if smtp_settings.encryption=='ssl' %}selected{% endif %}>SSL</option>
                            <option value="none" {% if smtp_settings.encryption=='none' %}selected{% endif %}>None
                            </option>
                        </select>
                    </div>

                    <div>
                        <label for="smtp_from_email"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">From Email</label>
                        <input type="email" id="smtp_from_email" name="smtp_from_email"
                            value="{{ smtp_settings.from_email }}" placeholder="noreply@example.com"
                            class="w-full px-4 py-2.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-theme">
                    </div>

                    <div>
                        <label for="smtp_from_name"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">From Name</label>
                        <input type="text" id="smtp_from_name" name="smtp_from_name"
                            value="{{ smtp_settings.from_name }}" placeholder="Your Store Name"
                            class="w-full px-4 py-2.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-theme">
                    </div>
                </div>

                <!-- Test Email Section -->
                <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Test Email Configuration</h4>
                    <div class="flex flex-wrap gap-3 items-end">
                        <div class="flex-1 min-w-[200px]">
                            <label for="test_email" class="block text-xs text-gray-500 dark:text-gray-500 mb-1">Test
                                Email Address</label>
                            <input type="email" id="test_email" placeholder="Enter email to send test"
                                class="w-full px-3 py-2 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white text-sm focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-theme">
                        </div>
                        <button type="button" id="testConnectionBtn" onclick="testConnection()"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Test Connection
                        </button>
                        <button type="button" id="sendTestEmailBtn" onclick="sendTestEmail()"
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                </path>
                            </svg>
                            Send Test Email
                        </button>
                    </div>
                    <div id="testResult" class="mt-3 hidden">
                        <div id="testResultContent" class="px-4 py-3 rounded-lg text-sm"></div>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-500 mt-2">Save settings before testing. Test
                        connection verifies SMTP credentials. Send test email sends an actual email.</p>
                </div>
            </div>
        </div>

        <!-- Admin Emails -->
        <div
            class="bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg p-6 shadow-sm dark:shadow-none transition-theme">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Admin Emails</h3>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Configure admin email addresses</p>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="admin_primary_email"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Primary Admin
                        Email</label>
                    <input type="email" id="admin_primary_email" name="admin_primary_email"
                        value="{{ admin_settings.primary_email }}" placeholder="admin@example.com"
                        class="w-full px-4 py-2.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-theme">
                    <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">Primary email address for admin
                        notifications</p>
                </div>

                <div>
                    <label for="admin_notification_emails"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notification
                        Emails</label>
                    <input type="text" id="admin_notification_emails" name="admin_notification_emails"
                        value="{{ admin_settings.notification_emails }}"
                        placeholder="email1@example.com, email2@example.com"
                        class="w-full px-4 py-2.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-theme">
                    <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">Comma-separated list of email addresses for
                        notifications</p>
                </div>
            </div>
        </div>
</div>
</div>

<!-- GitHub Updates Configuration -->
<div
    class="bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-800 rounded-lg p-6 shadow-sm dark:shadow-none transition-theme">
    <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 bg-gray-600 rounded-lg flex items-center justify-center">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path fill-rule="evenodd"
                    d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
                    clip-rule="evenodd"></path>
            </svg>
        </div>
        <div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Update System Configuration</h3>
            <p class="text-xs text-gray-500 dark:text-gray-500">Configure GitHub repository for automated updates</p>
        </div>
    </div>

    <div class="space-y-4">
        <div>
            <label for="github_token" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">GitHub
                Token</label>
            <input type="password" id="github_token" name="github_token"
                placeholder="{% if update_settings.github_token %}Token Set (Hidden){% else %}Enter GitHub Personal Access Token{% endif %}"
                class="w-full px-4 py-2.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-theme">
            <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">Leave blank to keep existing token. Token requires
                'repo' scope.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="repo_owner"
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Repository Owner</label>
                <input type="text" id="repo_owner" name="repo_owner" value="{{ update_settings.repo_owner }}"
                    placeholder="e.g. YourUsername or OrgName"
                    class="w-full px-4 py-2.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-theme">
            </div>

            <div>
                <label for="repo_name"
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Repository Name</label>
                <input type="text" id="repo_name" name="repo_name" value="{{ update_settings.repo_name }}"
                    placeholder="e.g. BaileBelle"
                    class="w-full px-4 py-2.5 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-theme">
            </div>
        </div>
    </div>
</div>

<div class="pt-6 border-t border-gray-200 dark:border-gray-800 flex justify-end">
    <button type="submit"
        class="px-6 py-2.5 bg-pink hover:bg-pink-dark text-white font-medium rounded-lg transition-colors">Save
        Changes</button>
</div>
</form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function showTestResult(success, message) {
        const resultDiv = document.getElementById('testResult');
        const contentDiv = document.getElementById('testResultContent');

        resultDiv.classList.remove('hidden');
        contentDiv.className = 'px-4 py-3 rounded-lg text-sm';

        if (success) {
            contentDiv.classList.add('bg-green-100', 'dark:bg-green-900/30', 'text-green-700', 'dark:text-green-400', 'border', 'border-green-200', 'dark:border-green-800');
            contentDiv.innerHTML = '<span class="flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' + message + '</span>';
        } else {
            contentDiv.classList.add('bg-red-100', 'dark:bg-red-900/30', 'text-red-700', 'dark:text-red-400', 'border', 'border-red-200', 'dark:border-red-800');
            contentDiv.innerHTML = '<span class="flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' + message + '</span>';
        }
    }

    function setButtonLoading(buttonId, loading) {
        const button = document.getElementById(buttonId);
        if (loading) {
            button.disabled = true;
            button.classList.add('opacity-50', 'cursor-not-allowed');
            const originalText = button.innerHTML;
            button.dataset.originalText = originalText;
            button.innerHTML = '<svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Testing...';
        } else {
            button.disabled = false;
            button.classList.remove('opacity-50', 'cursor-not-allowed');
            if (button.dataset.originalText) {
                button.innerHTML = button.dataset.originalText;
            }
        }
    }

    async function testConnection() {
        setButtonLoading('testConnectionBtn', true);

        try {
            const formData = new FormData();
            const response = await fetch('/admin/settings/test-smtp-connection', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            showTestResult(data.success, data.message);
        } catch (error) {
            showTestResult(false, 'Error: ' + error.message);
        } finally {
            setButtonLoading('testConnectionBtn', false);
        }
    }

    async function sendTestEmail() {
        const testEmail = document.getElementById('test_email').value.trim();

        if (!testEmail && !document.getElementById('admin_primary_email').value.trim()) {
            showTestResult(false, 'Please enter a test email address');
            return;
        }

        setButtonLoading('sendTestEmailBtn', true);

        try {
            const formData = new FormData();
            formData.append('test_email', testEmail);

            const response = await fetch('/admin/settings/send-test-email', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            showTestResult(data.success, data.message);
        } catch (error) {
            showTestResult(false, 'Error: ' + error.message);
        } finally {
            setButtonLoading('sendTestEmailBtn', false);
        }
    }
</script>
{% endblock %}