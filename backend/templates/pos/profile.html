{% extends "base.html" %}

{% block title %}My Profile - POS Dashboard{% endblock %}

{% block page_title %}Shop Profile{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
        <div class="p-6 sm:p-8">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">Shop Settings & Location</h2>

            <form action="{{ url_for('pos_dashboard.profile') }}" method="POST" class="space-y-6">
                <!-- Basic Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Business
                            Name</label>
                        <input type="text" name="business_name" value="{{ seller.business_name }}" required
                            class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-gold">
                    </div>
                </div>

                <!-- Address Section -->
                <div class="border-t border-gray-100 dark:border-gray-700 pt-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Location Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Address Line
                                1</label>
                            <input type="text" name="address_line1" value="{{ seller.address_line1 or '' }}"
                                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-gold">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">City</label>
                            <input type="text" name="city" value="{{ seller.city or '' }}"
                                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-gold">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">State /
                                Province</label>
                            <input type="text" name="state" value="{{ seller.state or '' }}"
                                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-gold">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Postal
                                Code</label>
                            <input type="text" name="zip_code" value="{{ seller.zip_code or '' }}"
                                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-gold">
                        </div>

                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Country</label>
                            <input type="text" name="country" value="{{ seller.country or '' }}"
                                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-gold">
                        </div>
                    </div>
                </div>

                <!-- Geolocation (Advanced) -->
                <div class="border-t border-gray-100 dark:border-gray-700 pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Geolocation</h3>
                        <span
                            class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-xs font-mono rounded text-gray-600 dark:text-gray-300">Advanced
                            Mode</span>
                    </div>
                    <p class="text-sm text-gray-500 mb-4">Coordinates are used for calculating delivery distance. You
                        can set these manually, use the button below, or select on the map.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Latitude</label>
                            <input type="text" name="latitude" id="latitude" value="{{ seller.latitude or '' }}"
                                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-gold font-mono">
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Longitude</label>
                            <input type="text" name="longitude" id="longitude" value="{{ seller.longitude or '' }}"
                                class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-gold font-mono">
                        </div>
                    </div>
                    
                    <div class="mt-4 flex gap-4">
                        <button type="button" onclick="getCurrentLocation()"
                            class="text-sm text-primary-gold hover:underline flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Get Current Location
                        </button>
                    </div>

                    <!-- Map Container -->
                    <div id="map" class="mt-4 w-full h-80 rounded-lg border border-gray-200 dark:border-gray-700 z-0"></div>
                </div>

                <!-- Settings -->
                <div class="border-t border-gray-100 dark:border-gray-700 pt-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Operational Settings</h3>
                    <div class="flex items-center gap-3">
                        <input type="checkbox" name="auto_accept_orders" id="auto_accept_orders" value="1" {% if
                            seller.auto_accept_orders %}checked{% endif %}
                            class="w-5 h-5 text-primary-gold border-gray-300 rounded focus:ring-primary-gold">
                        <label for="auto_accept_orders" class="text-gray-700 dark:text-gray-300">Auto-accept assigned
                            orders</label>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 ml-8">If enabled, orders assigned to you will be automatically
                        accepted.</p>
                </div>

                <div class="pt-6">
                    <button type="submit"
                        class="px-6 py-2.5 bg-black dark:bg-white text-white dark:text-black font-medium rounded-lg hover:bg-gray-800 dark:hover:bg-gray-100 transition-colors shadow-lg">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- LEAFLET CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // Initialize Map
    document.addEventListener('DOMContentLoaded', function() {
        // Default to New York or existing coords
        var lat = parseFloat(document.getElementById('latitude').value) || 40.7128;
        var lng = parseFloat(document.getElementById('longitude').value) || -74.0060;
        var hasLocation = document.getElementById('latitude').value && document.getElementById('longitude').value;

        var map = L.map('map').setView([lat, lng], hasLocation ? 15 : 4);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var marker;

        if (hasLocation) {
             marker = L.marker([lat, lng], {draggable: true}).addTo(map);
        }

        // Map Click Event
        map.on('click', function(e) {
            var clickedLat = e.latlng.lat;
            var clickedLng = e.latlng.lng;

            if (marker) {
                marker.setLatLng(e.latlng);
            } else {
                marker = L.marker(e.latlng, {draggable: true}).addTo(map);
                
                // Add drag event for new marker
                marker.on('dragend', function(event) {
                    var position = marker.getLatLng();
                    updateInputs(position.lat, position.lng);
                });
            }

            updateInputs(clickedLat, clickedLng);
        });

        // Existing Marker Drag Event
        if (marker) {
            marker.on('dragend', function(event) {
                var position = marker.getLatLng();
                updateInputs(position.lat, position.lng);
            });
        }

        function updateInputs(lat, lng) {
            document.getElementById('latitude').value = lat.toFixed(6);
            document.getElementById('longitude').value = lng.toFixed(6);
        }
    });

    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lng;
                
                // Update map view and marker is tricky since map variable is scoped. 
                // Simple reload or we accept that user clicks save.
                // But for better UX let's accept we rely on Manual input or Map click mostly.
                // If we really want to update map center we need to access map instance.
                // For now, let's keep it simple: inputs update, user can manually adjust map if needed.
                alert("Location found! Latitude: " + lat + ", Longitude: " + lng + ". Please scroll map to verify or click Save.");
                
            }, function (error) {
                alert("Error getting location: " + error.message);
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }
</script>
{% endblock %}
